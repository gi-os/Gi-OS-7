<script>
src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"
src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"
src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"
src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.js"
src="https://use.fontawesome.com/5af94ffd78.js"
//flag for localStorage
var flagShouldUpdate = true;

var Note = React.createClass({
  render: function() {
    var style = { backgroundColor: this.props.color };
    return (
      <div className="note" style={style}>
        <span className="delete-note" onClick={this.props.onDelete}>
          {" "}
          x{" "}
        </span>
        {this.props.children}
      </div>
    );
  }
});

var NoteSearch = React.createClass({
  handleSeach: function(event) {
    var searchQuery = event.target.value.toLowerCase();
    this.props.onSearch(searchQuery);
  },

  render: function() {
    return (
      <div className="search">
        <label>
          <input type="text" id="searchField" onChange={this.handleSeach} />
          <i className="fa fa-search fa-lg" aria-hidden="true" />
        </label>
      </div>
    );
  }
});

var NoteEditor = React.createClass({
  getInitialState: function() {
    return {
      text: "",
      color: "#8edb85"
    };
  },

  handleTextChange: function(event) {
    if (!flagShouldUpdate) {
      this.props.onSearchClearField();
    }
    this.setState({ text: event.target.value });
  },

  handleColorChange: function(event) {
    this.setState({ color: event.target.value });
  },

  handleNoteAdd: function() {
    var newNote = {
      text: this.state.text,
      color: this.state.color,
      id: Date.now()
    };
    this.props.onNoteAdd(newNote);
    this.setState({ text: "" });
  },

  render: function() {
    return (
      <div className="note-editor">
        <textarea
          className="textarea"
          placeholder="Enter your note here..."
          rows={5}
          value={this.state.text}
          onChange={this.handleTextChange}
        />
        <div className="color-label">
          <label>
            {" "}
            Choose a color:
            <input
              className="color-type"
              type="color"
              defaultValue="#8edb85"
              onChange={this.handleColorChange}
            />
          </label>
        </div>
        <button className="add-button" onClick={this.handleNoteAdd}>
          Add
        </button>
      </div>
    );
  }
});

var NotesGrid = React.createClass({
  componentDidMount: function() {
    var grid = this.refs.grid;
    this.msnry = new Masonry(grid, {
      itemSelector: ".note",
      columnWidth: 200,
      gutter: 10
    });
  },

  componentDidUpdate: function(prevProps) {
    if (this.props.notes.length !== prevProps.notes.length) {
      this.msnry.reloadItems();
      this.msnry.layout();
    }
  },

  render: function() {
    var noteDelete = this.props.onNoteDelete;
    return (
      <div className="notes-grid" ref="grid">
        {this.props.notes.map(function(note) {
          return (
            <Note
              key={note.id}
              color={note.color}
              onDelete={noteDelete.bind(null, note)}
            >
              {note.text}
            </Note>
          );
        })}
      </div>
    );
  }
});

var NotesApp = React.createClass({
  getInitialState: function() {
    return {
      notes: [
        {
          id: 0,
          text: "",
          color: "#a6e5e7"
        },
        {
          id: 1,
          text: "",
          color: "#b9f09f"
        },
        {
          id: 2,
          text: "",
          color: "#ee9ef0"
        },
        {
          id: 3,
          text: "",
          color: "#f0d49e"
        },
        {
          id: 4,
          text: "",
          color: "#a6e5e7"
        },
        {
          id: 5,
          text: "",
          color: "#82eec1"
        },
        {
          id: 6,
          text: "",
          color: "#c6df74"
        },
        {
          id: 7,
          text: "",
          color: "rgba(#64c1b3, 0.66)"
        }
      ]
    };
  },

  handleNoteAdd: function(newNote) {
    var newNotes = this.state.notes.slice();
    newNotes.unshift(newNote);
    if (!flagShouldUpdate) {
      this.handleClearSearchField();
    }
    flagShouldUpdate = true;
    this.setState({ notes: newNotes });
  },

  handleNoteDelete: function(note) {
    var noteId = note.id;
    var newNotes = this.state.notes.filter(function(note) {
      return note.id !== noteId;
    });
    flagShouldUpdate = true;
    this.setState({ notes: newNotes });
  },

  handleSearch: function(searchQuery) {
    var displayedNotes = JSON.parse(
      localStorage.getItem("notes")
    ).filter(function(el) {
      var searchValue = el.text.toLowerCase();
      return searchValue.indexOf(searchQuery) !== -1;
    });
    flagShouldUpdate = false;
    this.setState({ notes: displayedNotes }, this.render);
  },

  handleClearSearchField: function() {
    var searchField = document.getElementById("searchField");
    searchField.value = "";
    this.handleSearch("");
  },

  componentDidMount: function() {
    var localNotes = JSON.parse(localStorage.getItem("notes"));
    if (localNotes) {
      this.setState({ notes: localNotes });
    }
    console.log(document.getElementById("searchField"));
  },

  componentDidUpdate: function() {
    if (flagShouldUpdate) {
      this._updateLocalStorage();
    }
  },

  render: function() {
    return (
      <div className="notes-app">
        <NoteEditor
          onNoteAdd={this.handleNoteAdd}
          onSearchClearField={this.handleClearSearchField}
        />
        <NoteSearch onSearch={this.handleSearch} />
        <NotesGrid
          notes={this.state.notes}
          onNoteDelete={this.handleNoteDelete}
        />
      </div>
    );
  },

  _updateLocalStorage: function() {
    var notes = JSON.stringify(this.state.notes);
    localStorage.setItem("notes", notes);
  }
});

ReactDOM.render(<NotesApp />, document.getElementById("mount-point"));
</script>
<style>
* {
    box-sizing: border-box;
  font-family:lato;
  
}

body {
    font-weight: 300;
    background-color: #f2f2f2;
}

#mount-point {
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-orient: vertical;
    -webkit-box-direction: normal;
    -webkit-flex-direction: column;
        -ms-flex-direction: column;
            flex-direction: column;
    -webkit-box-align: center;
    -webkit-align-items: center;
        -ms-flex-align: center;
            align-items: center;
}

.note {
    width: 200px;
    height: auto;
    float: left;
    background-color: #8edb85;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    border-radius: 15px;
    padding: 10px;
    margin-bottom: 10px;
    -webkit-transition: box-shadow 
      .3s;
    transition: box-shadow .3s;
    white-space: pre-wrap;
    white-space: -moz-pre-wrap;
    white-space: -pre-wrap;
    white-space: -o-pre-wrap;
    word-wrap: break-word;
}

.note:hover {
    box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
}

.delete-note {
    position: absolute;
    top:5px;
    right:5px;
    display: none;
    color: rgba(0,0,0,0.6);
    cursor: pointer;
}

.delete-note: hover {
  color: black;
  text-shadow: 1px 1px 2px gray;
}

.note:hover .delete-note {
    display: block;
}

.note-editor {
  width: 100%;
  max-width: 600px;
  padding: 16px;
  margin: 16px auto;
  
  background-color: white;

  border-radius: 15px;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  -webkit-flex-direction: column;
      -ms-flex-direction: column;
          flex-direction: column;
}

.textarea {
    width: 100%;
    resize: none;
    margin: 5px;
    font-size: 14px;
    border: none;
    font-weight: 300;
}

.textarea:focus {
    outline: 0;
}

.add-button {
    -webkit-align-self: flex-end;
        -ms-flex-item-align: end;
            align-self: flex-end;
    width: 100px;
    background-color:#30bdff;
    border-radius:28px;
    border:0px solid #18ab29;
    cursor:pointer;
    color:#ffffff;
    font-size:14px;
    padding:8px 8px;
    text-transform: uppercase;
    text-decoration:none;

}

.add-button:hover {
    background-color:#60bdff;
}

.add-button:active {
    position:relative;
    top:1px;
}

.add-button:focus {
    outline: 0;
}

.notes-grid {
    margin: 0 auto;
    margin-left: 5%;
    font-family: lato;
}

.notes-app {
    max-width: 960px;
    width: 100%;
}

.app-header {
    text-align: center;
    font-weight: 500;
    font-size: 50px;
    color: grey;
    text-shadow: 0px 2px 3px rgba(255,255,255,0.5);
}

.color-label {
  cursor:pointer;
  align-self: flex-end;
  margin-bottom: 10px;
  color: gray;
  float:left;
}


.color-type {
	-webkit-appearance: none;
	border: none;
  padding-top: 10px;
	width: 24px;
	height: 24px;
  border-radius: 50%;
  position: relative;
  top: 7px;
  left: 4px;
  outline:none;
}
.color-type,input[type="color"]::-webkit-color-swatch-wrapper {
	padding: 0;
}
.color-type,input[type="color"]::-webkit-color-swatch {
  border-radius: 50%;
	border: none;
}

.search {
  margin: 0 auto 10px auto;
  width: 230px;

}

#searchField{
  border: none;
  border-radius: 15px;
  height: 24px;
  padding: 10px;
  
  background-color: white;
  font-size: 14px;
  font-weight: 300;
}

#searchField:focus {
    outline: 0;
}

.fa-search{
  color: gray;
  padding: 5px;
}
</style>
